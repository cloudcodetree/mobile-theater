# D-1.2: I2S Audio Output Test

| Field | Value |
|-------|-------|
| **Phase** | 1 - Wireless PoC |
| **Status** | â¬œ Not Started |
| **Cost** | $10 |
| **Depends On** | D-1.1 |

## Description

Connect a PCM5102A DAC to an ESP32-S3, configure I2S output, and play a test tone through headphones or powered speaker.

## Acceptance Criteria

- [ ] DAC wired correctly to ESP32
- [ ] I2S configured (48kHz, 16-bit, stereo)
- [ ] Test tone plays cleanly
- [ ] No audible noise or distortion
- [ ] Volume control works (if implemented)

## Bill of Materials

| Item | Qty | Unit Price | Total | Source | Status |
|------|-----|------------|-------|--------|--------|
| PCM5102A DAC Breakout | 1 | $5.00 | $5.00 | AliExpress | â¬œ |
| 3.5mm Audio Cable | 1 | $3.00 | $3.00 | Amazon | â¬œ |
| Breadboard | 1 | $2.00 | $2.00 | Amazon | â¬œ |

**Deliverable Total:** $10.00

## Tasks

- [ ] Wire PCM5102A to ESP32-S3 (see pinout below)
- [ ] Configure I2S peripheral in firmware
- [ ] Generate sine wave test tone (1kHz)
- [ ] Play through headphones/speaker
- [ ] Verify audio quality
- [ ] Test different sample rates
- [ ] Document results

## Technical Notes

### Wiring (ESP32-S3 to PCM5102A)

```
ESP32-S3          PCM5102A
â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€
3V3        â”€â”€â”€â”€â–º  VCC
GND        â”€â”€â”€â”€â–º  GND
GPIO 4     â”€â”€â”€â”€â–º  BCK  (Bit Clock)
GPIO 5     â”€â”€â”€â”€â–º  LCK  (Word Select / LRCK)
GPIO 6     â”€â”€â”€â”€â–º  DIN  (Data In)
           â”Œâ”€â”€â”€â–º  SCK  (tie to GND)
GND â”€â”€â”€â”€â”€â”€â”€â”¤
           â””â”€â”€â”€â–º  FMT  (tie to GND for I2S)
3V3        â”€â”€â”€â”€â–º  XSMT (tie to 3V3 = unmuted)
```

### Wiring Diagram

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PCM5102A      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                 â”‚
    â”‚  ESP32-S3 â”‚   â”‚  VCC â—„â”€â”€â”€â”€ 3V3  â”‚
    â”‚           â”‚   â”‚  GND â—„â”€â”€â”€â”€ GND  â”‚
    â”‚    GPIO4 â”€â”¼â”€â”€â”€â”¼â”€â–º BCK           â”‚
    â”‚    GPIO5 â”€â”¼â”€â”€â”€â”¼â”€â–º LCK           â”‚
    â”‚    GPIO6 â”€â”¼â”€â”€â”€â”¼â”€â–º DIN           â”‚
    â”‚           â”‚   â”‚  SCK â—„â”€â”€â”€â”€ GND  â”‚
    â”‚      3V3 â”€â”¼â”€â”€â”€â”¼â”€â–º XSMT          â”‚
    â”‚      GND â”€â”¼â”€â”€â”€â”¼â”€â–º FMT           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚          â”Œâ”€â”€â”€â”€â” â”‚
                    â”‚  L/R OUTâ”€â”¤3.5mmâ”‚â”€â”¼â”€â”€â–º ğŸ§
                    â”‚          â””â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### I2S Configuration

```cpp
#include "driver/i2s.h"

#define I2S_BCK  4
#define I2S_WS   5
#define I2S_DOUT 6

i2s_config_t i2s_config = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_TX),
    .sample_rate = 48000,
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
    .channel_format = I2S_CHANNEL_FMT_RIGHT_LEFT,
    .communication_format = I2S_COMM_FORMAT_STAND_I2S,
    .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
    .dma_buf_count = 8,
    .dma_buf_len = 256,
    .use_apll = true,
    .tx_desc_auto_clear = true
};

i2s_pin_config_t pin_config = {
    .bck_io_num = I2S_BCK,
    .ws_io_num = I2S_WS,
    .data_out_num = I2S_DOUT,
    .data_in_num = I2S_PIN_NO_CHANGE
};
```

### Test Tone Generation

```cpp
#include <math.h>

#define SAMPLE_RATE 48000
#define TONE_FREQ 1000
#define AMPLITUDE 16000

void generateTone(int16_t* buffer, size_t samples) {
    static float phase = 0;
    float phaseIncrement = 2.0 * M_PI * TONE_FREQ / SAMPLE_RATE;
    
    for (size_t i = 0; i < samples; i += 2) {
        int16_t sample = (int16_t)(AMPLITUDE * sin(phase));
        buffer[i] = sample;      // Left
        buffer[i + 1] = sample;  // Right
        phase += phaseIncrement;
        if (phase >= 2.0 * M_PI) phase -= 2.0 * M_PI;
    }
}
```

## Test Procedure

1. Power off ESP32
2. Wire DAC according to pinout
3. Double-check connections with multimeter (continuity)
4. Flash I2S test firmware
5. Connect headphones to DAC 3.5mm jack
6. Power on ESP32
7. Listen for clean 1kHz tone
8. Check for noise, clicks, or distortion
9. Test at different frequencies (440Hz, 1kHz, 10kHz)

## Expected Results

| Metric | Target | Actual |
|--------|--------|--------|
| Audio plays | Yes | â€” |
| Noise floor | Inaudible | â€” |
| Distortion | None | â€” |
| Sample rate | 48kHz verified | â€” |
| All frequencies clean | Yes | â€” |

## Troubleshooting

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| No audio | Wrong pins | Check wiring |
| Crackling | Buffer underrun | Increase DMA buffers |
| High pitch noise | Clock issues | Enable APLL |
| Mono only | Channel format | Check I2S_CHANNEL_FMT |

## References

- [PCM5102A Datasheet](https://www.ti.com/lit/ds/symlink/pcm5102a.pdf)
- [ESP32 I2S API](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/i2s.html)
- [ESP32 Audio Development](https://github.com/atomic14/esp32-audio)

## Work Log

### YYYY-MM-DD
- Started deliverable
