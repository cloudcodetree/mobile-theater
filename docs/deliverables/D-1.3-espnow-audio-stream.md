# D-1.3: ESP-NOW Audio Streaming Test

**Phase:** 1 — Wireless Proof of Concept  
**Estimated Cost:** $15  
**Status:** ⬜ Not Started  
**Dependencies:** D-1.1, D-1.2  

---

## Overview

Stream audio wirelessly from TX ESP32 to RX ESP32 using ESP-NOW protocol. This is the core proof-of-concept that validates the wireless speaker pod approach.

---

## Acceptance Criteria

- [ ] Audio streams continuously from TX to RX
- [ ] End-to-end latency < 30ms
- [ ] No audible dropouts during normal operation
- [ ] Packet loss < 1% at 10m range
- [ ] Audio quality acceptable (no major artifacts)

---

## Bill of Materials

| Item | Qty | Unit Price | Total | Source | Status |
|------|-----|------------|-------|--------|--------|
| (Uses D-1.1 and D-1.2 hardware) | — | — | $0 | — | ✅ |
| Logic Analyzer (optional) | 1 | $10.00 | $10.00 | Amazon | ⬜ |
| Oscilloscope (optional) | 1 | $5.00 | $5.00 | Amazon | ⬜ |
| **Total** | | | **$15** (optional) | | |

---

## Tasks

- [ ] Design packet format for audio data
- [ ] Implement TX: read audio → packetize → ESP-NOW send
- [ ] Implement RX: ESP-NOW receive → buffer → I2S output
- [ ] Add sequence numbers for packet ordering
- [ ] Implement jitter buffer on RX
- [ ] Measure latency with oscilloscope/logic analyzer
- [ ] Test range and packet loss
- [ ] Document results

---

## Technical Notes

### System Architecture

```
┌─────────────────┐         ESP-NOW         ┌─────────────────┐
│    TX ESP32     │      ═══════════►       │    RX ESP32     │
│                 │        2.4 GHz          │                 │
│  Audio Source   │                         │     PCM5102A    │
│  (I2S Input or  │                         │       DAC       │
│   Generated)    │                         │        │        │
│        │        │                         │        ▼        │
│        ▼        │                         │    Speaker/     │
│  Packetize      │                         │    Headphones   │
│  250 bytes/pkt  │                         │                 │
└─────────────────┘                         └─────────────────┘
```

### Packet Format

```c
typedef struct {
    uint32_t sequence;      // Packet sequence number
    uint32_t timestamp;     // Microsecond timestamp
    uint8_t  channel;       // Channel ID (for multi-speaker)
    uint8_t  flags;         // Reserved
    uint16_t sample_count;  // Number of samples
    int16_t  samples[120];  // 120 stereo samples = 240 bytes
} __attribute__((packed)) audio_packet_t;

// Total: 250 bytes (ESP-NOW max is 250)
```

### TX Firmware (Core Loop)

```c
#include <esp_now.h>
#include "driver/i2s_std.h"

#define SAMPLES_PER_PACKET 120

audio_packet_t packet;
uint32_t seq = 0;

void tx_audio_task(void *arg) {
    int16_t samples[SAMPLES_PER_PACKET * 2];  // Stereo
    size_t bytes_read;
    
    while (1) {
        // Read from I2S input (or generate test tone)
        i2s_channel_read(rx_handle, samples, sizeof(samples), &bytes_read, portMAX_DELAY);
        
        // Build packet
        packet.sequence = seq++;
        packet.timestamp = esp_timer_get_time();
        packet.channel = 0;
        packet.sample_count = SAMPLES_PER_PACKET;
        memcpy(packet.samples, samples, sizeof(samples));
        
        // Send via ESP-NOW (broadcast)
        esp_now_send(broadcast_addr, (uint8_t*)&packet, sizeof(packet));
    }
}
```

### RX Firmware (Core Loop)

```c
#include <freertos/queue.h>

#define BUFFER_SIZE 8  // Jitter buffer: 8 packets

QueueHandle_t audio_queue;
audio_packet_t buffer[BUFFER_SIZE];
int buffer_head = 0;

void on_receive(const uint8_t *mac, const uint8_t *data, int len) {
    audio_packet_t *pkt = (audio_packet_t*)data;
    xQueueSend(audio_queue, pkt, 0);  // Non-blocking
}

void rx_audio_task(void *arg) {
    audio_packet_t pkt;
    
    // Wait for buffer to fill (latency vs. robustness tradeoff)
    vTaskDelay(pdMS_TO_TICKS(20));
    
    while (1) {
        if (xQueueReceive(audio_queue, &pkt, portMAX_DELAY)) {
            // Write to I2S DAC
            size_t bytes_written;
            i2s_channel_write(tx_handle, pkt.samples, 
                              pkt.sample_count * 4, &bytes_written, portMAX_DELAY);
        }
    }
}
```

### Latency Budget

| Stage | Time |
|-------|------|
| Audio capture | ~2.5ms (120 samples @ 48kHz) |
| Packetization | <0.1ms |
| ESP-NOW TX | ~1-2ms |
| Air time | <0.1ms |
| ESP-NOW RX | ~1-2ms |
| Jitter buffer | ~5-10ms (configurable) |
| I2S output | ~2.5ms |
| **Total** | **~15-20ms** |

---

## Test Procedure

1. Flash TX firmware to Board 1
2. Flash RX firmware to Board 2 (with DAC connected)
3. Connect headphones to DAC
4. Power on both boards
5. Listen for continuous audio (test tone or input)
6. Measure latency:
   - Option A: Tap input, measure delay to speaker
   - Option B: Logic analyzer on TX GPIO and RX I2S
7. Walk RX board away from TX, note dropout distance
8. Log packet loss statistics (add counters to firmware)

---

## Expected Results

| Metric | Target | Actual |
|--------|--------|--------|
| Latency | <30ms | — |
| Packet loss (10m) | <1% | — |
| Dropout range | >15m indoor | — |
| Audio quality | Acceptable | — |

---

## Troubleshooting

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| No audio | ESP-NOW not connected | Check MAC addresses, use broadcast |
| Choppy audio | Buffer underrun | Increase jitter buffer size |
| High latency | Buffer too large | Reduce jitter buffer |
| Dropouts | Interference | Change WiFi channel |

---

## References

- [ESP-NOW Programming Guide](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_now.html)
- [Real-time Audio Streaming ESP32](https://github.com/atomic14/esp32-walkie-talkie)
- [Jitter Buffer Design](https://webrtc.googlesource.com/src/+/refs/heads/main/modules/audio_coding/neteq/)

---

## Work Log

### YYYY-MM-DD
- (Add progress notes here)
