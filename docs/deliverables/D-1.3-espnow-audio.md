# D-1.3: ESP-NOW Audio Streaming

| Field | Value |
|-------|-------|
| **Phase** | 1 - Wireless PoC |
| **Status** | â¬œ Not Started |
| **Cost** | $15 |
| **Depends On** | D-1.1, D-1.2 |

## Description

Combine ESP-NOW communication with I2S audio output to stream audio wirelessly from TX to RX. Measure end-to-end latency. This is the critical proof-of-concept for the entire project.

## Acceptance Criteria

- [ ] Audio streams from TX to RX over ESP-NOW
- [ ] End-to-end latency measured (<30ms target)
- [ ] Packet loss rate measured (<1% target)
- [ ] Audio quality acceptable (no constant artifacts)
- [ ] 10+ meter range verified

## Bill of Materials

| Item | Qty | Unit Price | Total | Source | Status |
|------|-----|------------|-------|--------|--------|
| Logic Analyzer (optional) | 1 | $10.00 | $10.00 | Amazon | â¬œ |
| Powered Speaker | 1 | $5.00 | $5.00 | (existing) | â¬œ |

**Deliverable Total:** $15.00

## Tasks

- [ ] Design audio packet format
- [ ] Implement TX: capture audio â†’ packetize â†’ send
- [ ] Implement RX: receive â†’ buffer â†’ I2S output
- [ ] Implement jitter buffer for smooth playback
- [ ] Add sequence numbers for packet loss detection
- [ ] Measure latency with oscilloscope/logic analyzer
- [ ] Test at various distances
- [ ] Document results and make go/no-go decision

## Technical Notes

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AUDIO STREAMING PIPELINE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  TX SIDE                              RX SIDE                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚                                                                         â”‚
â”‚  [Audio Source]                       [ESP-NOW RX]                      â”‚
â”‚       â”‚                                    â”‚                            â”‚
â”‚       â–¼                                    â–¼                            â”‚
â”‚  [I2S Input] â”€â”€â”€ or â”€â”€â”€â–º             [Jitter Buffer]                   â”‚
â”‚  [USB Audio]                               â”‚                            â”‚
â”‚  [Test Tone]                               â–¼                            â”‚
â”‚       â”‚                              [I2S Output]                       â”‚
â”‚       â–¼                                    â”‚                            â”‚
â”‚  [Packetize]                               â–¼                            â”‚
â”‚  250 samples                         [PCM5102A DAC]                     â”‚
â”‚  + seq number                              â”‚                            â”‚
â”‚       â”‚                                    â–¼                            â”‚
â”‚       â–¼                              [Amplifier]                        â”‚
â”‚  [ESP-NOW TX] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º       â”‚                            â”‚
â”‚       â”‚           2.4 GHz                  â–¼                            â”‚
â”‚       â”‚                              [Speaker] ðŸ”Š                       â”‚
â”‚       â”‚                                                                 â”‚
â”‚  â—„â”€â”€â”€â”€â”´â”€â”€â”€â”€ ACK (optional) â”€â”€â”€â”€                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Audio Packet Format

```cpp
struct AudioPacket {
    uint32_t sequence;      // Packet sequence number
    uint32_t timestamp;     // Microseconds since boot
    uint8_t  channel_id;    // For future multi-channel
    uint8_t  reserved[3];   // Alignment padding
    int16_t  samples[240];  // 240 stereo samples = 480 bytes
};
// Total: 492 bytes (ESP-NOW max is 250, so we need compression or smaller packets)
```

### Revised Packet (fits ESP-NOW 250 byte limit)

```cpp
struct AudioPacket {
    uint16_t sequence;      // 2 bytes
    uint8_t  flags;         // 1 byte (channel, compression, etc.)
    uint8_t  reserved;      // 1 byte
    int16_t  samples[122];  // 244 bytes (122 mono samples or 61 stereo)
};
// Total: 248 bytes âœ“
```

### Jitter Buffer

```cpp
#define BUFFER_SIZE 8  // Number of packets to buffer
#define SAMPLES_PER_PACKET 122

class JitterBuffer {
    AudioPacket packets[BUFFER_SIZE];
    uint16_t readIndex = 0;
    uint16_t writeIndex = 0;
    uint16_t expectedSeq = 0;
    
public:
    void push(AudioPacket* pkt) {
        // Insert packet at correct position based on sequence
        packets[writeIndex++ % BUFFER_SIZE] = *pkt;
    }
    
    bool pop(int16_t* samples) {
        if (readIndex == writeIndex) return false;
        memcpy(samples, packets[readIndex++ % BUFFER_SIZE].samples, 
               SAMPLES_PER_PACKET * sizeof(int16_t));
        return true;
    }
};
```

### Latency Budget

| Stage | Estimated Time |
|-------|----------------|
| Audio capture | 2.5ms (122 samples @ 48kHz) |
| Packetization | <0.1ms |
| ESP-NOW TX | 1-3ms |
| RF propagation | <0.01ms |
| ESP-NOW RX | 1-2ms |
| Jitter buffer | 5-10ms (2-4 packets) |
| I2S output | 2.5ms (one buffer) |
| **Total** | **~12-20ms** |

### Latency Measurement

```cpp
// TX: Send timestamp
packet.timestamp = esp_timer_get_time();
esp_now_send(peer, (uint8_t*)&packet, sizeof(packet));

// RX: Calculate latency (requires synchronized clocks or loopback)
uint32_t latency = esp_timer_get_time() - packet.timestamp;
Serial.printf("Latency: %lu us\n", latency);
```

For accurate measurement, use a loopback test or oscilloscope:
1. TX generates tone + sends packet
2. RX plays tone
3. Oscilloscope measures delay between TX audio out and RX audio out

## Test Procedure

1. Flash TX firmware to Board 1
2. Flash RX firmware to Board 2
3. Connect DAC to RX board
4. Connect speaker to DAC
5. Power both boards
6. Verify audio plays on speaker
7. Measure latency using scope or loopback
8. Test at 1m, 5m, 10m distances
9. Count packet loss over 1 minute
10. Document audio quality subjectively

## Expected Results

| Metric | Target | Acceptable | Actual |
|--------|--------|------------|--------|
| End-to-end latency | <20ms | <30ms | â€” |
| Packet loss | <0.5% | <1% | â€” |
| Range (line of sight) | 15m | 10m | â€” |
| Audio quality | Excellent | Good | â€” |

## Go/No-Go Decision

### âœ… GO to Phase 2 if:
- Latency â‰¤30ms
- Packet loss â‰¤1%
- Range â‰¥10m
- Audio quality is "good" or better

### âŒ NO-GO if:
- Latency >50ms consistently
- Packet loss >5%
- Range <5m
- Audio has constant artifacts

### ðŸ”„ PIVOT OPTIONS:
- WiFi UDP multicast (higher bandwidth, more latency jitter)
- nRF24L01+ custom RF (lower latency, more work)
- Commercial wireless audio modules

## References

- [ESP-NOW Max Payload](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_now.html)
- [Audio Streaming Best Practices](https://github.com/atomic14/esp32-audio)
- [Jitter Buffer Design](https://en.wikipedia.org/wiki/Jitter_buffer)

## Work Log

### YYYY-MM-DD
- Started deliverable
